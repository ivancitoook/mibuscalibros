<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel del Bibliotecario</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
    * { box-sizing: border-box; }
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 40px 20px;
      background: white;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }
    .container {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(6px);
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 12px 28px rgba(0, 0, 0, 0.2);
      width: 100%;
      max-width: 1000px;
    }
    h1 {
      text-align: center;
      color: #004aad;
      margin-bottom: 30px;
    }
    form {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }
    form div { display: flex; flex-direction: column; }
    label { font-weight: 600; margin-bottom: 5px; color: #333; }
    input, select {
      padding: 10px 14px;
      border-radius: 10px;
      border: 2px solid #ccdbe9;
      background-color: #f9fcff;
      font-size: 15px;
    }
    input:focus, select:focus {
      border-color: #004aad;
      outline: none;
      background-color: #e9f5fc;
    }
    button {
      grid-column: span 2;
      padding: 12px;
      border: none;
      border-radius: 12px;
      background-color: #004aad;
      color: white;
      font-weight: bold;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:hover { background-color: #00358c; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ccc;
    }
    th {
      background-color: #e9f5fc;
      color: #004aad;
    }
    .acciones button {
      padding: 6px 10px;
      font-size: 14px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-right: 5px;
    }
    .eliminar { background-color: #e74c3c; color: white; }
    .aceptar { background-color: #27ae60; color: white; }
    .rechazar { background-color: #c0392b; color: white; }
    .editar { background-color: #f39c12; color: white; }
    .exportar {
      background-color: #27ae60;
      color: white;
      margin-top: 15px;
    }
    .libro-img {
      width: 60px;
      height: auto;
      border-radius: 6px;
    }
    .filter {
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .filter input {
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
      width: 200px;
    }
    .perfil {
      display: flex;
      gap: 20px;
      align-items: center;
      margin-bottom: 20px;
    }
    .perfil img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
    }
    .cerrar-sesion {
      display: block;
      text-align: center;
      margin-top: 20px;
      background-color: #e74c3c;
      color: white;
      font-weight: bold;
      padding: 12px;
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .cerrar-sesion:hover { background-color: #c0392b; }
  </style>
</head>
<body>
  <div class="container">
      <!-- Perfil del bibliotecario -->
      <div class="perfil" id="perfilInfo">
        <img src="https://cdn.pixabay.com/photo/2023/02/18/11/00/icon-7797704_1280.png" alt="Perfil Bibliotecario" />
        <span>Bibliotecario: Aaron Segovia</span>
      </div>  
    <h1>Gestión de Préstamos</h1>
    <form id="prestamoForm">
      <div><label>Nombre</label><input type="text" id="nombre" required /></div>
      <div><label>Domicilio</label><input type="text" id="domicilio" required /></div>
      <div><label>Teléfono</label><input type="tel" id="telefono" required /></div>
      <div><label>Fiador o Aval</label><input type="text" id="fiador" required /></div>
      <div><label>Libro</label><input type="text" id="libro" required /></div>
      <div><label>URL Imagen del Libro</label><input type="url" id="imagenLibro" /></div>
      <div><label>Bibliotecario</label><input type="text" id="bibliotecario" required /></div>
      <div>
        <label>Biblioteca</label>
        <select id="biblioteca" required>
          <option value="Biblioteca Fortino León Almada">Biblioteca Fortino León Almada</option>
          <option value="Biblioteca Rafael Meneses">Biblioteca Rafael Meneses</option>
        </select>
      </div>
      <button type="submit">Agregar Solicitud</button>
    </form>

    <div class="filter">
      <input type="text" id="buscar" placeholder="Buscar por nombre o libro..." />
      <button class="exportar" onclick="exportarPDF()">Exportar PDF</button>
    </div>

    <table id="tablaHistorial">
      <thead>
        <tr>
          <th>Imagen</th><th>Nombre</th><th>Domicilio</th><th>Teléfono</th><th>Fiador</th><th>Libro</th><th>Biblioteca</th><th>Bibliotecario</th><th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h2 style="margin-top:40px;color:#004aad">Préstamos Concluidos</h2>
    <table id="tablaConcluidos">
      <thead>
        <tr>
          <th>Nombre</th><th>Libro</th><th>Bibliotecario</th><th>Fecha Conclusión</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- Botón de Cerrar sesión -->
    <button class="cerrar-sesion" onclick="cerrarSesion()">Cerrar sesión</button>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('prestamoForm');
      const tabla = document.getElementById('tablaHistorial').querySelector('tbody');
      const concluidosTabla = document.getElementById('tablaConcluidos').querySelector('tbody');
      const buscar = document.getElementById('buscar');

      let solicitudes = JSON.parse(localStorage.getItem('solicitudes')) || [];
      let concluidos = JSON.parse(localStorage.getItem('concluidos')) || [];

      function renderTabla() {
        tabla.innerHTML = '';
        const filtro = buscar.value.toLowerCase();

        solicitudes.filter(p =>
          p.nombre.toLowerCase().includes(filtro) ||
          p.libro.toLowerCase().includes(filtro)
        ).forEach((p, i) => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td><img src="${p.imagen || 'https://via.placeholder.com/60'}" class="libro-img"></td>
            <td>${p.nombre}</td>
            <td>${p.domicilio}</td>
            <td>${p.telefono}</td>
            <td>${p.fiador}</td>
            <td>${p.libro}</td>
            <td>${p.biblioteca || ''}</td>
            <td>${p.autorizadoPor || ''}</td>
            <td class="acciones">
              <button class="editar" onclick="editarPrestamo(${i})">Editar</button>
              ${p.estado === 'pendiente' ? `
                <button class="aceptar" onclick="aceptarPrestamo(${i})">Aceptar</button>
                <button class="rechazar" onclick="rechazarPrestamo(${i})">Rechazar</button>` :
                `<button class="eliminar" onclick="eliminarPrestamo(${i})">Concluir</button>`
              }
            </td>
          `;
          tabla.appendChild(row);
        });

        // Concluidos
        concluidosTabla.innerHTML = '';
        concluidos.forEach(p => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${p.nombre}</td><td>${p.libro}</td><td>${p.autorizadoPor || ''}</td><td>${p.fecha_conclusion || ''}</td>
          `;
          concluidosTabla.appendChild(row);
        });
      }

      window.editarPrestamo = function(i) {
        const p = solicitudes[i];
        document.getElementById('nombre').value = p.nombre;
        document.getElementById('domicilio').value = p.domicilio;
        document.getElementById('telefono').value = p.telefono;
        document.getElementById('fiador').value = p.fiador;
        document.getElementById('libro').value = p.libro;
        document.getElementById('imagenLibro').value = p.imagen;
        document.getElementById('bibliotecario').value = p.autorizadoPor;
        document.getElementById('biblioteca').value = p.biblioteca;
        solicitudes.splice(i, 1);
      }

      window.aceptarPrestamo = function(i) {
        solicitudes[i].estado = 'aceptado';
        solicitudes[i].fecha = new Date().toLocaleDateString();
        localStorage.setItem('solicitudes', JSON.stringify(solicitudes));
        renderTabla();
      }

      window.rechazarPrestamo = function(i) {
        solicitudes.splice(i, 1);
        localStorage.setItem('solicitudes', JSON.stringify(solicitudes));
        renderTabla();
      }

      window.eliminarPrestamo = function(i) {
        const eliminado = solicitudes.splice(i, 1)[0];
        eliminado.fecha_conclusion = new Date().toLocaleDateString();
        concluidos.push(eliminado);
        localStorage.setItem('concluidos', JSON.stringify(concluidos));
        localStorage.setItem('solicitudes', JSON.stringify(solicitudes));
        renderTabla();
      }

      form.addEventListener('submit', e => {
        e.preventDefault();
        const nuevo = {
          nombre: document.getElementById('nombre').value,
          domicilio: document.getElementById('domicilio').value,
          telefono: document.getElementById('telefono').value,
          fiador: document.getElementById('fiador').value,
          libro: document.getElementById('libro').value,
          imagen: document.getElementById('imagenLibro').value,
          autorizadoPor: document.getElementById('bibliotecario').value,
          biblioteca: document.getElementById('biblioteca').value,
          estado: 'pendiente'
        };
        solicitudes.push(nuevo);
        localStorage.setItem('solicitudes', JSON.stringify(solicitudes));
        form.reset();
        renderTabla();
      });

      buscar.addEventListener('input', renderTabla);

      window.exportarPDF = function() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(12);

        let y = 20;
        doc.text("📚 Préstamos Aceptados", 14, y);
        y += 10;

        solicitudes.filter(p => p.estado === 'aceptado').forEach((p, idx) => {
          const lines = [
            `#${idx + 1}`,
            `Nombre: ${p.nombre}`,
            `Domicilio: ${p.domicilio}`,
            `Teléfono: ${p.telefono}`,
            `Fiador: ${p.fiador}`,
            `Libro: ${p.libro}`,
            `Biblioteca: ${p.biblioteca || 'N/A'}`,
            `Fecha: ${p.fecha || 'N/A'}`,
            `Autorizado por: ${p.autorizadoPor || 'N/A'}`,
            ''
          ];
          lines.forEach(line => {
            doc.text(line, 14, y);
            y += 8;
            if (y > 270) { doc.addPage(); y = 20; }
          });
        });

        y += 10;
        doc.text("✅ Préstamos Concluidos", 14, y);
        y += 10;
        concluidos.forEach((p, idx) => {
          const lines = [
            `#${idx + 1}`,
            `Nombre: ${p.nombre}`,
            `Libro: ${p.libro}`,
            `Biblioteca: ${p.biblioteca || 'N/A'}`,
            `Fecha de préstamo: ${p.fecha || 'N/A'}`,
            `Concluido el: ${p.fecha_conclusion || 'N/A'}`,
            `Autorizado por: ${p.autorizadoPor || 'N/A'}`,
            ''
          ];
          lines.forEach(line => {
            doc.text(line, 14, y);
            y += 8;
            if (y > 270) { doc.addPage(); y = 20; }
          });
        });

        doc.save("historial_prestamos.pdf");
      }

      // Función de "Cerrar sesión"
      window.cerrarSesion = function() {
        window.location.href = "iniciosesionbibliotecario.html";  // Redirige a la página de inicio de sesión
      }

      renderTabla();
    });
  </script>
</body>
</html>
